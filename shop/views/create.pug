body
    include mixins/snackbarMixin
    block content
        link(rel='stylesheet', type='text/css', href='/stylesheets/create.css')
        include mixins/formsMixin
        p Tags
        br
        +tcForm('/admin/create/tags')
        button#tags.refresh Refresh
        #tagsEdit.modal
            .modal-content
                span.close ×
                +tcForm('/admin/edit/tags')
        table#tagsResults.display(table='tags')
            thead
                tr
                th Id
                th Name
                th Color
                th Visible
                th
                th 
            tbody
        p Categories
        br
        +tcForm('/admin/create/categories')
        button#categories.refresh Refresh
        #categoriesEdit.modal
            .modal-content
                span.close ×
                +tcForm('/admin/edit/categories')
        table#categoriesResults.display(table='categories')
            thead
                tr
                th Id
                th Name
                th Color
                th Visible
                th
                th 
            tbody
        p Products
        br
        +productForm('/admin/create/products')
        button#products.refresh Refresh
        #productsEdit.modal
            .modal-content
                span.close ×
                +productForm('/admin/edit/products')
        table#productsResults.display(table='products')
            thead
                tr
                th Id
                th Name
                th Manufacturer
                th Description
                th Cost
                th Category
                th Visible
                th
                th 
            tbody
        +snackbar()
    block scripts
        link(rel='stylesheet', type='text/css', href='https://cdn.datatables.net/1.10.21/css/jquery.dataTables.css')
        script(type='text/javascript', charset='utf8', src='https://cdn.datatables.net/1.10.21/js/jquery.dataTables.js')
        script.
            $(document).ready( function () {
                var columns = [
                        { data: 'id' },
                        { data: 'name' },
                        { data: 'color' },
                        { data: 'visible' },
                        { targets: -1, data: null, defaultContent: "<button class='editRecord'>Edit</button>"},
                        { targets: -1, data: null, defaultContent: "<button class='deleteRecord'>X</button>"}
                    ];
                var productColumns = [
                        { data: 'id' },
                        { data: 'name' },
                        { data: 'manifacturer' },
                        { data: 'description' },
                        { data: 'cost' },
                        { data: 'category' },
                        { data: 'visible' },
                        { targets: -1, data: null, defaultContent: "<button class='editRecord'>Edit</button>"},
                        { targets: -1, data: null, defaultContent: "<button class='deleteRecord'>X</button>"}
                    ];
                var tables = { tags: $('#tagsResults').DataTable( {
                    paging: true,
                    scrollY: 400,
                    columns: columns
                }),  categories: $('#categoriesResults').DataTable({
                    paging: true,
                    scrollY: 400,
                    columns: columns
                }), products: $('#productsResults').DataTable({
                    paging: true,
                    scrollY: 400,
                    columns: productColumns})}
                var editId = null;
                $('.display tbody').on( 'click', 'button.editRecord', function () {
                    //prefil data todo
                    var modal = $(`#${$(this).parents('table').attr('table')}Edit`);
                    modal.on('click', '.close', function(){ modal.css("display","none"); console.log(modal)});
                    modal.css("display","block");
                    editId = tables[$(this).parents('table').attr('table')]
                    .row( $(this).parents('tr') ).data()['id'];
                } );
                $('.display tbody').on( 'click', 'button.deleteRecord', function () {
                    var data = tables[$(this).parents('table').attr('table')]
                    .row( $(this).parents('tr') ).data();
                    if(confirm(`Delete record with Id: ${data['id']} and Name: ${data['name']}`)){
                        $.ajax({
                            data: {id: data['id']},
                            type: 'POST',
                            url: "/admin/delete/" + $(this).parents('table').attr('table'),
                            dataType: 'json',
                            success: function(data){
                                refresh(data['table'])
                            },
                            error: function(data){
                                errorHandle(data.responseJSON, null)
                            }
                        });
                    }
                } );
                $('.refresh').on('click', function(e){
                   refresh($(this).attr('id'));
                });

                function refresh(tableName, callback) {
                     $.ajax({
                        type: 'GET',
                        url: "/admin/getAll/" + tableName,
                        success: function(data){
                            if(callback) {
                                callback(data);
                            }else {
                                table = tables[data['table']]
                                if(table){
                                    table.clear().draw();
                                    table.rows.add(data['result']).draw();
                                }
                                editId = null;
                            }
                        },
                        error: function(data){
                            errorHandle(data.responseJSON, null)
                        }
                    })
                }

                $(".productCategoryRefresh").on('click', function(e) {
                    var select = $(this).siblings('.productCategory')
                    select.empty();
                    refresh('categories', function (data) {
                        $.each(data['result'], function(_, value){
                            select.append($('<option>', { 
                                value: value.id.toString(10),
                                text : value.name 
                            }));
                        })
                    });
                });
                $('form').on('submit', function(event) {
                    var data = {}
                    var form = this;
                    if($(this).parent().attr('class') == "modal-content") {
                        data['id'] = editId;
                    }
                    genericSubmitForm(data, event, form, function(data){
                            var ul = $(form).children('.errors')[0]
                            if(ul){
                                ul.innerHTML = "";
                            }
                            refresh(data['table']);
                        })
                });
            });